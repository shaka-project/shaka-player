<!DOCTYPE html>
<!--
 Copyright 2016 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shaka Player - Playback Sync Demo</title>

  <style>
    /* ============================================
       CSS Variables & Base Styles
       ============================================ */
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-color);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* ============================================
       Layout
       ============================================ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary-color), #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      color: var(--text-secondary);
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============================================
       Video Container
       ============================================ */
    .video-section {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .video-container {
      position: relative;
      width: 100%;
      background: #000;
    }

    video {
      width: 100%;
      display: block;
    }

    .video-info {
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border-color);
    }

    .video-title {
      font-weight: 600;
    }

    .video-time {
      color: var(--text-secondary);
      font-family: monospace;
      font-size: 0.9rem;
    }

    /* ============================================
       Control Panel
       ============================================ */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ============================================
       Form Elements
       ============================================ */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    input[type="text"]::placeholder {
      color: var(--text-secondary);
    }

    /* ============================================
       Buttons
       ============================================ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      font-size: 0.95rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .btn-warning {
      background: var(--warning-color);
      color: #1e293b;
    }

    .btn-warning:hover:not(:disabled) {
      background: #d97706;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--bg-color);
      border-color: var(--text-secondary);
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    .btn-group .btn {
      flex: 1;
    }

    /* ============================================
       Status Indicators
       ============================================ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-badge.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger-color);
    }

    .status-badge.connected {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success-color);
    }

    .status-badge.master {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning-color);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ============================================
       Log Panel
       ============================================ */
    .log-panel {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.8rem;
      line-height: 1.8;
    }

    .log-entry {
      color: var(--text-secondary);
    }

    .log-entry.info {
      color: var(--primary-color);
    }

    .log-entry.success {
      color: var(--success-color);
    }

    .log-entry.warning {
      color: var(--warning-color);
    }

    .log-entry.error {
      color: var(--danger-color);
    }

    .log-time {
      color: var(--text-secondary);
      margin-right: 0.5rem;
    }

    /* ============================================
       Instructions
       ============================================ */
    .instructions {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }

    .instructions h3 {
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      color: var(--primary-color);
    }

    .instructions ol {
      margin-left: 1.25rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .instructions li {
      margin-bottom: 0.5rem;
    }

    .instructions code {
      background: var(--bg-color);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    /* ============================================
       Users List
       ============================================ */
    .users-list {
      list-style: none;
    }

    .users-list li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
    }

    .users-list li:last-child {
      border-bottom: none;
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .user-you {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>ðŸŽ¬ Playback Sync Demo</h1>
      <p>Synchronize video playback across multiple clients using PubNub</p>
    </header>

    <div class="main-grid">
      <!-- Video Section -->
      <div class="video-section">
        <div class="video-container" id="video-container">
          <video id="video"
                 poster="https://shaka-player-demo.appspot.com/assets/poster.jpg"
                 controls>
          </video>
        </div>
        <div class="video-info">
          <span class="video-title" id="video-title">No video loaded</span>
          <span class="video-time" id="video-time">00:00 / 00:00</span>
        </div>
      </div>

      <!-- Control Panel -->
      <div class="control-panel">
        <!-- Connection Status -->
        <div class="card">
          <h2>Connection Status</h2>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="status-badge disconnected" id="connection-status">
              <span class="status-dot"></span>
              Disconnected
            </span>
            <span class="status-badge" id="role-status" style="display: none;">
              Follower
            </span>
          </div>
        </div>

        <!-- PubNub Configuration -->
        <div class="card">
          <h2>PubNub Keys</h2>
          <div class="form-group">
            <label for="publish-key">Publish Key</label>
            <input type="text" id="publish-key" placeholder="pub-c-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" value="demo">
          </div>
          <div class="form-group">
            <label for="subscribe-key">Subscribe Key</label>
            <input type="text" id="subscribe-key" placeholder="sub-c-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" value="demo">
          </div>
          <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Using "demo" keys for testing. Replace with your own keys from
            <a href="https://admin.pubnub.com" target="_blank" style="color: var(--primary-color);">PubNub Admin</a>.
          </p>
        </div>

        <!-- Room Controls -->
        <div class="card">
          <h2>Sync Room</h2>
          <div class="form-group">
            <label for="room-id">Room ID</label>
            <input type="text" id="room-id" placeholder="watch-party-123" value="demo-room">
          </div>
          <div class="btn-group" style="margin-top: 1rem;">
            <button class="btn btn-primary" id="btn-connect">Connect</button>
            <button class="btn btn-danger" id="btn-disconnect" disabled>Disconnect</button>
          </div>
        </div>

        <!-- Role Controls -->
        <div class="card" id="role-controls" style="display: none;">
          <h2>Role Control</h2>
          <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
            The <strong>Master</strong> controls playback for everyone. Followers receive sync commands.
          </p>
          <div class="btn-group">
            <button class="btn btn-warning" id="btn-master">Become Master</button>
            <button class="btn btn-outline" id="btn-follower">Become Follower</button>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
          <h2>Activity Log</h2>
          <div class="log-panel" id="log-panel">
            <div class="log-entry">Ready to connect...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="instructions">
      <h3>ðŸ“‹ How to Test</h3>
      <ol>
        <li>Open this page in <strong>two browser windows</strong> (or different devices)</li>
        <li>Enter the same <strong>Room ID</strong> in both windows</li>
        <li>Click <strong>Connect</strong> in both windows</li>
        <li>In one window, click <strong>Become Master</strong></li>
        <li>Play, pause, or seek the video in the Master window</li>
        <li>Watch the other window sync automatically!</li>
      </ol>
    </div>
  </div>

  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.8.0.0.min.js"></script>

  <!-- Local keys file (gitignored) - create keys.local.js with your keys -->
  <script src="keys.local.js" onerror="console.log('No local keys file found, using demo keys')"></script>

  <!-- Shaka Player from CDN + local sync module -->
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.14.5/dist/shaka-player.ui.js"></script>
  
  <!-- Load the sync module separately (inline for GitHub Pages compatibility) -->
  <script>
    // SyncManager - PubNub-powered playback synchronization
    (function() {
      'use strict';
      
      /**
       * SyncManager enables real-time playback synchronization between multiple
       * clients using PubNub as the messaging layer.
       */
      shaka.sync = shaka.sync || {};
      
      shaka.sync.SyncManager = class extends shaka.util.FakeEventTarget {
        constructor(player, config) {
          super();
          this.player_ = player;
          this.video_ = player.getMediaElement();
          this.config_ = config;
          this.pubnub_ = null;
          this.subscription_ = null;
          this.channelName_ = '';
          this.userId_ = config.userId || ('shaka-user-' + Math.random().toString(36).substr(2, 9));
          this.role_ = 'follower';
          this.isProcessingRemoteCommand_ = false;
          this.isConnected_ = false;
          this.syncTimer_ = null;
          this.maxDriftThreshold_ = config.maxDriftThreshold || 0.5;
          this.syncIntervalMs_ = config.syncIntervalMs || 5000;
          this.boundHandlers_ = {
            onPlay: () => this.onLocalPlay_(),
            onPause: () => this.onLocalPause_(),
            onSeeked: () => this.onLocalSeeked_(),
            onRateChange: () => this.onLocalRateChange_(),
          };
          console.log('SyncManager created with userId:', this.userId_);
        }

        connect(roomId) {
          if (typeof PubNub === 'undefined') {
            throw new Error('PubNub SDK not found. Include it via script tag.');
          }
          if (!this.config_.publishKey || !this.config_.subscribeKey) {
            throw new Error('PubNub publishKey and subscribeKey are required.');
          }
          if (!this.video_) {
            throw new Error('No video element attached to player.');
          }

          this.channelName_ = roomId;
          console.log('Connecting to sync room:', this.channelName_);

          this.pubnub_ = new PubNub({
            publishKey: this.config_.publishKey,
            subscribeKey: this.config_.subscribeKey,
            userId: this.userId_,
            enableEventEngine: true,
          });

          this.pubnub_.addListener({
            status: (statusEvent) => this.onPubNubStatus_(statusEvent),
          });

          const channel = this.pubnub_.channel(this.channelName_);
          this.subscription_ = channel.subscription({ receivePresenceEvents: true });
          this.subscription_.onMessage = (event) => this.onPubNubMessage_(event);
          this.subscription_.onPresence = (event) => this.onPubNubPresence_(event);
          this.subscription_.subscribe();
          this.attachVideoListeners_();
          this.isConnected_ = true;
          console.log('Successfully connected to sync room:', roomId);
        }

        disconnect() {
          console.log('Disconnecting from sync room:', this.channelName_);
          if (this.syncTimer_) {
            clearInterval(this.syncTimer_);
            this.syncTimer_ = null;
          }
          this.detachVideoListeners_();
          if (this.subscription_) {
            this.subscription_.unsubscribe();
            this.subscription_ = null;
          }
          if (this.pubnub_) {
            this.pubnub_.removeAllListeners();
            this.pubnub_.destroy();
            this.pubnub_ = null;
          }
          this.isConnected_ = false;
          this.role_ = 'follower';
          this.channelName_ = '';
          console.log('Disconnected from sync room');
        }

        becomeMaster() {
          console.log('This client is now the MASTER controller');
          this.role_ = 'master';
          this.broadcastMasterClaim_();
          this.broadcastFullState_();
          this.startSyncInterval_();
        }

        becomeFollower() {
          console.log('This client is now a FOLLOWER');
          this.role_ = 'follower';
          if (this.syncTimer_) {
            clearInterval(this.syncTimer_);
            this.syncTimer_ = null;
          }
        }

        getRole() { return this.role_; }
        isConnected() { return this.isConnected_; }
        getRoomId() { return this.channelName_; }
        getUserId() { return this.userId_; }

        async destroy() {
          await this.disconnect();
          this.player_ = null;
          this.video_ = null;
          this.config_ = null;
          this.boundHandlers_ = null;
        }

        attachVideoListeners_() {
          if (!this.video_) return;
          this.video_.addEventListener('play', this.boundHandlers_.onPlay);
          this.video_.addEventListener('pause', this.boundHandlers_.onPause);
          this.video_.addEventListener('seeked', this.boundHandlers_.onSeeked);
          this.video_.addEventListener('ratechange', this.boundHandlers_.onRateChange);
        }

        detachVideoListeners_() {
          if (!this.video_) return;
          this.video_.removeEventListener('play', this.boundHandlers_.onPlay);
          this.video_.removeEventListener('pause', this.boundHandlers_.onPause);
          this.video_.removeEventListener('seeked', this.boundHandlers_.onSeeked);
          this.video_.removeEventListener('ratechange', this.boundHandlers_.onRateChange);
        }

        onLocalPlay_() {
          if (this.isProcessingRemoteCommand_ || this.role_ !== 'master') return;
          this.broadcastCommand_('play', { currentTime: this.video_.currentTime });
        }

        onLocalPause_() {
          if (this.isProcessingRemoteCommand_ || this.role_ !== 'master') return;
          this.broadcastCommand_('pause', { currentTime: this.video_.currentTime });
        }

        onLocalSeeked_() {
          if (this.isProcessingRemoteCommand_ || this.role_ !== 'master') return;
          this.broadcastCommand_('seek', { currentTime: this.video_.currentTime });
        }

        onLocalRateChange_() {
          if (this.isProcessingRemoteCommand_ || this.role_ !== 'master') return;
          this.broadcastCommand_('ratechange', { playbackRate: this.video_.playbackRate });
        }

        async broadcastCommand_(command, payload) {
          if (!this.pubnub_ || !this.isConnected_) return;
          const message = {
            type: 'SYNC_COMMAND',
            command: command,
            payload: Object.assign({}, payload, {
              timestamp: Date.now(),
              senderId: this.userId_,
              isPaused: this.video_.paused,
            }),
          };
          try {
            await this.pubnub_.publish({ channel: this.channelName_, message: message });
          } catch (error) {
            console.error('Failed to broadcast command:', error);
          }
        }

        async broadcastMasterClaim_() {
          if (!this.pubnub_ || !this.isConnected_) return;
          const message = {
            type: 'MASTER_CLAIM',
            payload: { timestamp: Date.now(), senderId: this.userId_ },
          };
          try {
            await this.pubnub_.publish({ channel: this.channelName_, message: message });
          } catch (error) {
            console.error('Failed to broadcast master claim:', error);
          }
        }

        broadcastFullState_() {
          this.broadcastCommand_('sync', {
            currentTime: this.video_.currentTime,
            playbackRate: this.video_.playbackRate,
            isPaused: this.video_.paused,
          });
        }

        startSyncInterval_() {
          if (this.syncTimer_) clearInterval(this.syncTimer_);
          this.syncTimer_ = setInterval(() => {
            if (this.role_ === 'master' && this.video_ && !this.video_.paused) {
              this.broadcastFullState_();
            }
          }, this.syncIntervalMs_);
        }

        onPubNubMessage_(event) {
          const message = event.message;
          if (message.payload && message.payload.senderId === this.userId_) return;
          
          if (message.type === 'MASTER_CLAIM') {
            this.handleMasterClaim_(message.payload);
            return;
          }
          
          if (message.type !== 'SYNC_COMMAND' || this.role_ !== 'follower') return;
          this.applyRemoteCommand_(message.command, message.payload);
        }

        handleMasterClaim_(payload) {
          if (this.role_ === 'master') {
            console.log('Another user claimed master role:', payload.senderId);
            this.becomeFollower();
            this.dispatchEvent(new shaka.util.FakeEvent('masterchanged', new Map([
              ['newMasterId', payload.senderId],
              ['previousRole', 'master'],
            ])));
          } else {
            this.dispatchEvent(new shaka.util.FakeEvent('masterchanged', new Map([
              ['newMasterId', payload.senderId],
              ['previousRole', 'follower'],
            ])));
          }
        }

        applyRemoteCommand_(command, payload) {
          this.isProcessingRemoteCommand_ = true;
          const latencyMs = Date.now() - payload.timestamp;
          const latencySec = latencyMs / 1000;

          switch (command) {
            case 'play':
              if (payload.currentTime !== undefined) {
                this.video_.currentTime = payload.currentTime + latencySec;
              }
              this.video_.play().catch(e => console.warn('Play failed:', e));
              break;
            case 'pause':
              this.video_.pause();
              if (payload.currentTime !== undefined) {
                this.video_.currentTime = payload.currentTime;
              }
              break;
            case 'seek':
              if (payload.currentTime !== undefined) {
                this.video_.currentTime = payload.currentTime + latencySec;
              }
              break;
            case 'ratechange':
              if (payload.playbackRate !== undefined) {
                this.video_.playbackRate = payload.playbackRate;
              }
              break;
            case 'sync':
              this.handleSyncPulse_(payload, latencySec);
              break;
          }

          setTimeout(() => { this.isProcessingRemoteCommand_ = false; }, 100);
        }

        handleSyncPulse_(payload, latencySec) {
          if (payload.currentTime !== undefined) {
            const expectedTime = payload.currentTime + latencySec;
            const drift = Math.abs(this.video_.currentTime - expectedTime);
            if (drift > this.maxDriftThreshold_) {
              this.video_.currentTime = expectedTime;
            }
          }
          if (payload.playbackRate !== undefined && this.video_.playbackRate !== payload.playbackRate) {
            this.video_.playbackRate = payload.playbackRate;
          }
          if (payload.isPaused && !this.video_.paused) {
            this.video_.pause();
          } else if (!payload.isPaused && this.video_.paused) {
            this.video_.play().catch(e => console.warn('Play failed during sync:', e));
          }
        }

        onPubNubStatus_(statusEvent) {
          console.log('PubNub status:', statusEvent.category);
        }

        onPubNubPresence_(presenceEvent) {
          console.log('Presence event:', presenceEvent.action, presenceEvent.uuid);
        }
      };
      
      console.log('SyncManager module loaded');
    })();
  </script>

  <script>
    // ============================================
    // Demo Application
    // ============================================

    // Load keys from local file if available
    const localKeys = window.PUBNUB_KEYS || null;

    // DOM Elements
    const videoElement = document.getElementById('video');
    const videoContainer = document.getElementById('video-container');
    const videoTitle = document.getElementById('video-title');
    const videoTime = document.getElementById('video-time');
    const connectionStatus = document.getElementById('connection-status');
    const roleStatus = document.getElementById('role-status');
    const roleControls = document.getElementById('role-controls');
    const logPanel = document.getElementById('log-panel');

    const publishKeyInput = document.getElementById('publish-key');
    const subscribeKeyInput = document.getElementById('subscribe-key');
    const roomIdInput = document.getElementById('room-id');

    const btnConnect = document.getElementById('btn-connect');
    const btnDisconnect = document.getElementById('btn-disconnect');
    const btnMaster = document.getElementById('btn-master');
    const btnFollower = document.getElementById('btn-follower');

    // App State
    let player = null;
    let syncManager = null;

    // Sample video for testing
    const sampleVideo = {
      title: 'Big Buck Bunny',
      url: 'https://storage.googleapis.com/shaka-demo-assets/bbb-dark-truths/dash.mpd'
    };

    // ============================================
    // Logging
    // ============================================
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // ============================================
    // UI Updates
    // ============================================
    function updateConnectionUI(connected) {
      if (connected) {
        connectionStatus.className = 'status-badge connected';
        connectionStatus.innerHTML = '<span class="status-dot"></span> Connected';
        btnConnect.disabled = true;
        btnDisconnect.disabled = false;
        roleControls.style.display = 'block';
        roleStatus.style.display = 'inline-flex';
      } else {
        connectionStatus.className = 'status-badge disconnected';
        connectionStatus.innerHTML = '<span class="status-dot"></span> Disconnected';
        btnConnect.disabled = false;
        btnDisconnect.disabled = true;
        roleControls.style.display = 'none';
        roleStatus.style.display = 'none';
      }
    }

    function updateRoleUI(role) {
      if (role === 'master') {
        roleStatus.className = 'status-badge master';
        roleStatus.textContent = 'ðŸ‘‘ Master';
        btnMaster.disabled = true;
        btnFollower.disabled = false;
      } else {
        roleStatus.className = 'status-badge connected';
        roleStatus.textContent = 'ðŸ‘¥ Follower';
        btnMaster.disabled = false;
        btnFollower.disabled = true;
      }
    }

    function updateVideoTime() {
      if (!videoElement.duration) return;

      const current = formatTime(videoElement.currentTime);
      const duration = formatTime(videoElement.duration);
      videoTime.textContent = `${current} / ${duration}`;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // ============================================
    // Shaka Player Setup
    // ============================================
    async function initPlayer() {
      // Install polyfills
      shaka.polyfill.installAll();

      // Check browser support
      if (!shaka.Player.isBrowserSupported()) {
        log('Browser not supported!', 'error');
        return false;
      }

      // Create player
      player = new shaka.Player();
      await player.attach(videoElement);

      // Error handling
      player.addEventListener('error', (event) => {
        log(`Player error: ${event.detail.message}`, 'error');
      });

      // Load sample video
      try {
        await player.load(sampleVideo.url);
        videoTitle.textContent = sampleVideo.title;
        log(`Loaded: ${sampleVideo.title}`, 'success');
      } catch (error) {
        log(`Failed to load video: ${error.message}`, 'error');
        return false;
      }

      // Update time display
      videoElement.addEventListener('timeupdate', updateVideoTime);

      return true;
    }

    // ============================================
    // Sync Manager Setup
    // ============================================
    async function connect() {
      const publishKey = publishKeyInput.value.trim();
      const subscribeKey = subscribeKeyInput.value.trim();
      const roomId = roomIdInput.value.trim();

      if (!publishKey || !subscribeKey) {
        log('Please enter PubNub keys', 'error');
        return;
      }

      if (!roomId) {
        log('Please enter a Room ID', 'error');
        return;
      }

      try {
        log(`Connecting to room: ${roomId}...`);

        // Create SyncManager
        syncManager = new shaka.sync.SyncManager(player, {
          publishKey: publishKey,
          subscribeKey: subscribeKey,
        });

        // Set up event listeners before connecting
        setupSyncManagerListeners();

        // Connect to the room
        await syncManager.connect(roomId);

        updateConnectionUI(true);
        updateRoleUI('follower');
        log(`Connected to room: ${roomId}`, 'success');
        log(`Your ID: ${syncManager.getUserId()}`);

      } catch (error) {
        log(`Connection failed: ${error.message}`, 'error');
      }
    }

    async function disconnect() {
      if (syncManager) {
        await syncManager.disconnect();
        syncManager = null;
      }
      updateConnectionUI(false);
      log('Disconnected from room', 'warning');
    }

    function becomeMaster() {
      if (syncManager) {
        syncManager.becomeMaster();
        updateRoleUI('master');
        log('You are now the MASTER - your playback controls everyone!', 'success');
      }
    }

    function becomeFollower() {
      if (syncManager) {
        syncManager.becomeFollower();
        updateRoleUI('follower');
        log('You are now a FOLLOWER - waiting for sync commands', 'info');
      }
    }

    function setupSyncManagerListeners() {
      if (!syncManager) return;

      // Listen for master changes (when another client claims master)
      syncManager.addEventListener('masterchanged', (event) => {
        // FakeEvent sets Map entries as direct properties on the event
        const newMasterId = event.newMasterId;
        const previousRole = event.previousRole;

        if (previousRole === 'master') {
          // We were the master but someone else claimed it
          updateRoleUI('follower');
          log(`Another user (${newMasterId}) claimed master - you are now a follower`, 'warning');
        } else {
          // We're a follower and someone became master
          log(`User ${newMasterId} is now the master`, 'info');
        }
      });
    }

    // ============================================
    // Event Listeners
    // ============================================
    btnConnect.addEventListener('click', connect);
    btnDisconnect.addEventListener('click', disconnect);
    btnMaster.addEventListener('click', becomeMaster);
    btnFollower.addEventListener('click', becomeFollower);

    // ============================================
    // Initialize
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Load local keys if available (from keys.local.js)
      if (localKeys) {
        publishKeyInput.value = localKeys.publishKey || 'demo';
        subscribeKeyInput.value = localKeys.subscribeKey || 'demo';
        log('Loaded keys from keys.local.js', 'success');
      }

      log('Initializing Shaka Player...');
      const success = await initPlayer();
      if (success) {
        log('Ready! Enter room details and click Connect.', 'success');
      }
    });
  </script>
</body>
</html>

